<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Isyarasa</title>
    
    <!-- 1. Framework & Icons -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- 2. Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <!-- 3. MediaPipe (Versi Stabil) -->
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .scale-x-flipped { transform: scaleX(-1); }
        .hidden { display: none !important; }
        
        .loader {
            border: 3px solid #f3f3f3;
            border-radius: 50%;
            border-top: 3px solid #34d399;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        @keyframes shrink { from { width: 100%; } to { width: 0%; } }
        .limit-bar { animation: shrink 5s linear forwards; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 min-h-screen flex flex-col">

    <!-- SCREEN 1: LOADING -->
    <div id="screen-loading" class="fixed inset-0 bg-slate-50 flex flex-col items-center justify-center z-50">
        <div class="loader mb-4" style="width: 40px; height: 40px;"></div>
        <p class="text-slate-500 font-medium">Memuat Sistem...</p>
    </div>

    <!-- SCREEN 2: INTRO (NAMA) -->
    <div id="screen-intro" class="hidden fixed inset-0 bg-slate-50 flex items-center justify-center z-40 p-4">
        <div class="bg-white max-w-md w-full rounded-2xl shadow-xl p-8 text-center space-y-6">
            <div class="w-32 h-32 mx-auto mb-2 flex items-center justify-center">
                <img src="https://ndkqyftbtzmrzjlcoulz.supabase.co/storage/v1/object/public/assets/logo%20(1).png" 
                     alt="Logo Isyarasa" 
                     class="w-full h-full object-contain">
            </div>
            <div>
                <h1 class="text-3xl font-bold text-slate-800">Isyarasa by Sankara</h1>
                <p class="text-slate-500 mt-2">Bantu kami mengumpulkan data gerakan bahasa isyarat untuk pengembangan AI.</p>
            </div>
            <div class="text-left space-y-2">
                <label class="text-sm font-semibold text-slate-700">Siapa Nama Anda?</label>
                <input type="text" id="input-contributor" 
                    class="w-full px-4 py-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-emerald-400 outline-none transition"
                    placeholder="Masukkan nama atau inisial">
                <p id="intro-error" class="text-red-500 text-sm hidden"></p>
            </div>
            <button id="btn-start-session" class="w-full bg-emerald-400 hover:bg-emerald-500 text-white font-bold py-3 rounded-lg transition flex items-center justify-center shadow-lg shadow-emerald-100">
                Mulai Kontribusi <i data-lucide="arrow-right" class="w-5 h-5 ml-2"></i>
            </button>
        </div>
    </div>

    <!-- SCREEN 3: COMPLETED -->
    <div id="screen-completed" class="hidden fixed inset-0 bg-slate-50 flex items-center justify-center z-40 p-4">
        <div class="bg-white max-w-md w-full rounded-2xl shadow-xl p-8 text-center space-y-6 animate-in zoom-in duration-300">
            <div class="w-20 h-20 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-2">
                <i data-lucide="trophy" class="w-10 h-10 text-green-500"></i>
            </div>
            <div>
                <h1 class="text-2xl font-bold text-slate-800">Selesai! Terima Kasih</h1>
                <p class="text-slate-500 mt-2">
                    Luar biasa, <strong id="completed-name">User</strong>! Anda telah menyelesaikan seluruh rangkaian gerakan.
                </p>
            </div>
            <button onclick="location.reload()" class="w-full bg-white border border-slate-300 hover:bg-slate-50 text-slate-700 font-bold py-3 rounded-lg transition">
                Kembali ke Halaman Utama
            </button>
        </div>
    </div>

    <!-- SCREEN 4: MAIN RECORDING -->
    <div id="screen-main" class="hidden flex-1 flex flex-col">
        <div class="bg-white shadow-sm sticky top-0 z-30">
            <div class="h-1 bg-slate-200 w-full">
                <div id="progress-bar" class="h-full bg-emerald-400 transition-all duration-500" style="width: 0%"></div>
            </div>
            <div class="container mx-auto px-4 py-3 flex justify-between items-center">
                <div class="flex items-center">
                    <button id="btn-prev-word" class="hidden mr-3 p-1 rounded-full hover:bg-slate-100 text-slate-500 transition">
                        <i data-lucide="chevron-left" class="w-5 h-5"></i>
                    </button>
                    <div class="flex flex-col md:flex-row md:items-center text-sm">
                        <span class="font-medium text-slate-500 mr-2" id="step-counter">Kata 1 dari 10:</span>
                        <strong class="text-slate-800 text-lg" id="current-target-label">...</strong>
                    </div>
                </div>
                <button id="btn-skip-word" class="text-xs text-slate-400 hover:text-slate-600 flex items-center">
                    Lewati <i data-lucide="skip-forward" class="w-3 h-3 ml-1"></i>
                </button>
            </div>
        </div>

        <main class="container mx-auto px-4 py-6 max-w-5xl flex-1">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 h-full">
                <!-- LEFT: EXAMPLE -->
                <div class="space-y-4 flex flex-col">
                    <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-200 h-full flex flex-col">
                        <h3 class="font-bold text-slate-700 mb-2 flex items-center">
                            <i data-lucide="play" class="w-4 h-4 mr-2 text-emerald-500"></i> Contoh Gerakan
                        </h3>
                        <div class="relative aspect-video bg-black rounded-lg overflow-hidden flex-1">
                            <video id="video-reference" class="w-full h-full object-contain" autoplay loop muted playsinline></video>
                        </div>
                        <p class="text-sm text-slate-500 mt-3 bg-yellow-50 p-3 rounded-lg border border-yellow-100">
                            ðŸ’¡ <strong>Tips:</strong> Tiru gerakan di video. Pastikan tangan terlihat jelas di kamera.
                        </p>
                    </div>
                </div>

                <!-- RIGHT: CAMERA -->
                <div class="space-y-4 flex flex-col">
                    <div class="bg-white p-4 rounded-xl shadow-md border border-slate-200 relative flex-1 flex flex-col">
                        <div class="flex justify-between items-center mb-2">
                            <h3 class="font-bold text-slate-700 flex items-center">
                                <i data-lucide="camera" class="w-4 h-4 mr-2 text-red-500"></i> Kamera Anda
                            </h3>
                            <button id="btn-toggle-rig" class="hidden text-xs text-emerald-500 hover:underline flex items-center">
                                <i data-lucide="scan-face" class="w-3 h-3 mr-1"></i>
                                <span id="rig-text">Sembunyikan Rig</span>
                            </button>
                        </div>

                        <div class="relative aspect-video bg-black rounded-lg overflow-hidden w-full">
                            <div id="camera-overlay" class="absolute inset-0 flex items-center justify-center bg-slate-900 z-30">
                                <button id="btn-enable-cam" class="bg-white/10 hover:bg-white/20 text-white px-6 py-3 rounded-full backdrop-blur-sm border border-white/20 transition flex items-center">
                                    <i data-lucide="camera" class="w-5 h-5 mr-2"></i> Nyalakan Kamera
                                </button>
                            </div>

                            <div id="live-container" class="relative w-full h-full transform scale-x-flipped hidden">
                                <video id="video-preview" class="absolute inset-0 w-full h-full object-cover" autoplay muted playsinline></video>
                                <canvas id="canvas-rig" class="absolute inset-0 w-full h-full pointer-events-none"></canvas>
                                
                                <div id="limit-progress-container" class="hidden absolute top-0 left-0 w-full h-1 bg-white/30 z-50">
                                    <div id="limit-progress-bar" class="h-full bg-red-500 w-full"></div>
                                </div>
                            </div>

                            <video id="video-playback" class="absolute inset-0 w-full h-full object-contain bg-black z-20 hidden" controls></video>

                            <div id="rec-indicator" class="hidden absolute top-4 right-4 flex items-center bg-red-600 text-white px-3 py-1 rounded-full animate-pulse text-xs font-bold z-40">
                                <div class="w-2 h-2 bg-white rounded-full mr-2"></div> REC
                            </div>
                        </div>

                        <div class="mt-4 flex gap-3">
                            <button id="btn-record" class="hidden flex-1 bg-red-500 hover:bg-red-600 text-white py-3 rounded-lg font-bold shadow transition flex items-center justify-center">
                                <div class="w-3 h-3 bg-white rounded-full mr-2"></div> Rekam (Maks 5 Detik)
                            </button>
                            <button id="btn-stop" class="hidden flex-1 bg-slate-800 hover:bg-slate-900 text-white py-3 rounded-lg font-bold shadow transition flex items-center justify-center">
                                <i data-lucide="square" class="w-4 h-4 mr-2 fill-current"></i> Stop
                            </button>
                            <div id="review-actions" class="hidden w-full flex gap-3">
                                <button id="btn-retry" class="flex-1 bg-white border border-slate-300 text-slate-700 hover:bg-slate-50 py-3 rounded-lg font-bold transition flex items-center justify-center">
                                    <i data-lucide="refresh-ccw" class="w-4 h-4 mr-2"></i> Ulang
                                </button>
                                <button id="btn-upload" class="flex-[3] bg-emerald-400 hover:bg-emerald-500 text-white py-3 rounded-lg font-bold shadow transition flex items-center justify-center">
                                    <i data-lucide="upload-cloud" class="w-4 h-4 mr-2"></i> Lanjut
                                </button>
                            </div>
                        </div>
                        <p id="error-message" class="text-red-500 text-xs text-center mt-2 hidden"></p>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // --- DATA ---
        const TARGET_WORDS = [
            { label: "Iya", url: "https://ndkqyftbtzmrzjlcoulz.supabase.co/storage/v1/object/public/assets/iya.mp4" },
            { label: "Maaf", url: "https://ndkqyftbtzmrzjlcoulz.supabase.co/storage/v1/object/public/assets/Maaf.mp4" },
            { label: "Mau", url: "https://ndkqyftbtzmrzjlcoulz.supabase.co/storage/v1/object/public/assets/mau.mp4" },
            { label: "Nama", url: "https://ndkqyftbtzmrzjlcoulz.supabase.co/storage/v1/object/public/assets/Nama.mp4" },
            { label: "Perkenalkan", url: "https://ndkqyftbtzmrzjlcoulz.supabase.co/storage/v1/object/public/assets/Perkenalkan.mp4" },
            { label: "Salam Kenal", url: "https://ndkqyftbtzmrzjlcoulz.supabase.co/storage/v1/object/public/assets/Salamkenal.mp4" },
            { label: "Sama-sama", url: "https://ndkqyftbtzmrzjlcoulz.supabase.co/storage/v1/object/public/assets/sama-sama.mp4" },
            { label: "Terima Kasih", url: "https://ndkqyftbtzmrzjlcoulz.supabase.co/storage/v1/object/public/assets/Terimakasih.mp4" },
            { label: "Tidak", url: "https://ndkqyftbtzmrzjlcoulz.supabase.co/storage/v1/object/public/assets/tidak.mp4" },
            { label: "Tolong", url: "https://ndkqyftbtzmrzjlcoulz.supabase.co/storage/v1/object/public/assets/tolong.mp4" }
        ];

        const SUPABASE_URL = "https://ndkqyftbtzmrzjlcoulz.supabase.co";
        const SUPABASE_KEY = "sb_publishable__aO8IFA_UUmagkK30qhN6w_zU-IHOgv";

        // --- GLOBAL ---
        let supabaseClient = null; // Renamed from 'supabase' to avoid collision with library
        let hands = null;
        let currentIndex = 0;
        let contributorName = "";
        let stream = null;
        let mediaRecorder = null;
        let recordedChunks = [];
        let videoBlob = null;
        let isRigging = true;
        let recordingTimeout = null;

        const screens = {
            loading: document.getElementById('screen-loading'),
            intro: document.getElementById('screen-intro'),
            main: document.getElementById('screen-main'),
            completed: document.getElementById('screen-completed')
        };

        const els = {
            inputName: document.getElementById('input-contributor'),
            introError: document.getElementById('intro-error'),
            progressBar: document.getElementById('progress-bar'),
            stepCounter: document.getElementById('step-counter'),
            targetLabel: document.getElementById('current-target-label'),
            videoRef: document.getElementById('video-reference'),
            btnEnableCam: document.getElementById('btn-enable-cam'),
            camOverlay: document.getElementById('camera-overlay'),
            liveContainer: document.getElementById('live-container'),
            videoPreview: document.getElementById('video-preview'),
            canvasRig: document.getElementById('canvas-rig'),
            videoPlayback: document.getElementById('video-playback'),
            recIndicator: document.getElementById('rec-indicator'),
            limitProgressContainer: document.getElementById('limit-progress-container'),
            limitProgressBar: document.getElementById('limit-progress-bar'),
            btnToggleRig: document.getElementById('btn-toggle-rig'),
            rigText: document.getElementById('rig-text'),
            btnRecord: document.getElementById('btn-record'),
            btnStop: document.getElementById('btn-stop'),
            reviewActions: document.getElementById('review-actions'),
            btnRetry: document.getElementById('btn-retry'),
            btnUpload: document.getElementById('btn-upload'),
            btnPrev: document.getElementById('btn-prev-word'),
            btnSkip: document.getElementById('btn-skip-word'),
            errorMsg: document.getElementById('error-message')
        };

        function showScreen(name) {
            Object.values(screens).forEach(el => el.classList.add('hidden'));
            if (screens[name]) screens[name].classList.remove('hidden');
        }

        window.onload = async () => {
            lucide.createIcons();
            
            // Langsung munculkan intro agar tidak stuck loading
            showScreen('intro');

            // 1. Init Supabase
            try {
                if (window.supabase) {
                    supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
                }
            } catch (e) { console.error("Supabase fail", e); }

            // 2. Init MediaPipe
            try {
                if (window.Hands) {
                    hands = new window.Hands({
                        locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`
                    });
                    hands.setOptions({
                        maxNumHands: 2,
                        modelComplexity: 1,
                        minDetectionConfidence: 0.5,
                        minTrackingConfidence: 0.5
                    });
                    hands.onResults(onResults);
                }
            } catch (err) { console.error("MediaPipe Error:", err); }
        };

        document.getElementById('btn-start-session').addEventListener('click', () => {
            const name = els.inputName.value.trim();
            if (!name) {
                els.introError.innerText = "Mohon isi nama Anda.";
                els.introError.classList.remove('hidden');
                return;
            }
            contributorName = name;
            showScreen('main');
            loadWord(0);
        });

        function loadWord(index) {
            currentIndex = index;
            const word = TARGET_WORDS[index];
            const percent = (index / TARGET_WORDS.length) * 100;
            
            els.progressBar.style.width = `${percent}%`;
            els.stepCounter.innerText = `Kata ${index + 1} dari ${TARGET_WORDS.length}:`;
            els.targetLabel.innerText = word.label;
            els.videoRef.src = word.url;
            
            resetRecordingState();
            
            if (index > 0) els.btnPrev.classList.remove('hidden');
            else els.btnPrev.classList.add('hidden');
        }

        function resetRecordingState() {
            videoBlob = null;
            recordedChunks = [];
            els.videoPlayback.classList.add('hidden');
            els.videoPlayback.src = "";
            els.reviewActions.classList.add('hidden');
            els.btnStop.classList.add('hidden');
            els.recIndicator.classList.add('hidden');
            els.errorMsg.classList.add('hidden');
            
            if (stream) {
                els.liveContainer.classList.remove('hidden');
                els.btnRecord.classList.remove('hidden');
            } else {
                els.camOverlay.classList.remove('hidden');
            }
        }

        async function startCamera() {
            try {
                stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { width: 1280, height: 720, facingMode: 'user' } 
                });
                els.videoPreview.srcObject = stream;
                els.camOverlay.classList.add('hidden');
                els.liveContainer.classList.remove('hidden');
                els.btnRecord.classList.remove('hidden');
                els.btnToggleRig.classList.remove('hidden');
                
                els.videoPreview.onloadedmetadata = () => {
                    els.canvasRig.width = els.videoPreview.videoWidth;
                    els.canvasRig.height = els.videoPreview.videoHeight;
                    predictLoop();
                };
            } catch (err) {
                alert("Kamera diblokir atau tidak tersedia.");
            }
        }

        els.btnEnableCam.addEventListener('click', startCamera);

        async function predictLoop() {
            if (stream && isRigging && hands && els.videoPreview.readyState >= 2 && !els.liveContainer.classList.contains('hidden')) {
                try { await hands.send({image: els.videoPreview}); } catch(e) {}
            }
            requestAnimationFrame(predictLoop);
        }

        function onResults(results) {
            const ctx = els.canvasRig.getContext('2d');
            ctx.save();
            ctx.clearRect(0, 0, els.canvasRig.width, els.canvasRig.height);
            if (isRigging && results.multiHandLandmarks) {
                for (const landmarks of results.multiHandLandmarks) {
                    drawConnectors(ctx, landmarks, HAND_CONNECTIONS, {color: '#34d399', lineWidth: 4});
                    drawLandmarks(ctx, landmarks, {color: '#f87171', lineWidth: 1, radius: 4});
                }
            }
            ctx.restore();
        }

        els.btnRecord.addEventListener('click', () => {
            recordedChunks = [];
            mediaRecorder = new MediaRecorder(stream, { mimeType: 'video/webm' });
            mediaRecorder.ondataavailable = e => { if(e.data.size > 0) recordedChunks.push(e.data); };
            mediaRecorder.onstop = () => {
                clearTimeout(recordingTimeout);
                els.limitProgressContainer.classList.add('hidden');
                els.limitProgressBar.classList.remove('limit-bar');
                videoBlob = new Blob(recordedChunks, { type: 'video/webm' });
                const url = URL.createObjectURL(videoBlob);
                els.liveContainer.classList.add('hidden');
                els.videoPlayback.src = url;
                els.videoPlayback.classList.remove('hidden');
                els.recIndicator.classList.add('hidden');
                els.btnStop.classList.add('hidden');
                els.reviewActions.classList.remove('hidden');
            };

            mediaRecorder.start();
            els.btnRecord.classList.add('hidden');
            els.btnStop.classList.remove('hidden');
            els.recIndicator.classList.remove('hidden');
            els.limitProgressContainer.classList.remove('hidden');
            void els.limitProgressBar.offsetWidth;
            els.limitProgressBar.classList.add('limit-bar');

            recordingTimeout = setTimeout(() => {
                if (mediaRecorder.state === 'recording') mediaRecorder.stop();
            }, 5000);
        });

        els.btnStop.addEventListener('click', () => mediaRecorder.stop());
        els.btnRetry.addEventListener('click', resetRecordingState);

        els.btnUpload.addEventListener('click', async () => {
            if (!videoBlob || !supabaseClient) return;
            const btn = els.btnUpload;
            btn.disabled = true;
            btn.innerText = "Mengirim...";

            const word = TARGET_WORDS[currentIndex].label;
            const filename = `${word}/${Date.now()}.webm`;

            try {
                const { error: upErr } = await supabaseClient.storage.from('dataset-videos').upload(filename, videoBlob);
                if (upErr) throw upErr;

                const { data: urlData } = supabaseClient.storage.from('dataset-videos').getPublicUrl(filename);
                await supabaseClient.from('datasets').insert([{
                    label: word,
                    contributor_name: contributorName,
                    video_url: urlData.publicUrl,
                    status: 'pending'
                }]);

                btn.innerText = "Berhasil!";
                setTimeout(() => {
                    btn.disabled = false;
                    btn.innerHTML = `<i data-lucide="upload-cloud" class="w-4 h-4 mr-2"></i> Lanjut`;
                    if (currentIndex < TARGET_WORDS.length - 1) loadWord(currentIndex + 1);
                    else showCompleted();
                }, 1000);
            } catch (err) {
                alert("Gagal upload ke server.");
                btn.disabled = false;
                btn.innerText = "Coba Lagi";
            }
        });

        els.btnPrev.addEventListener('click', () => { if(currentIndex > 0) loadWord(currentIndex - 1); });
        els.btnSkip.addEventListener('click', () => {
            if(currentIndex < TARGET_WORDS.length - 1) loadWord(currentIndex + 1);
            else showCompleted();
        });

        function showCompleted() {
            document.getElementById('completed-name').innerText = contributorName;
            if(stream) stream.getTracks().forEach(t => t.stop());
            showScreen('completed');
        }

        els.btnToggleRig.addEventListener('click', () => {
            isRigging = !isRigging;
            els.rigText.innerText = isRigging ? "Sembunyikan Rig" : "Tampilkan Rig";
        });
    </script>
</body>
</html>
